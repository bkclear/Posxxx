<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Instagram Bulk Manager</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; margin-bottom: 10px; }
    .card { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 8px; }
    button { margin-top: 5px; }
  </style>
</head>
<body>
  <h2>Instagram Bulk Manager</h2>

  <textarea id="bulkInput" rows="4" placeholder="Paste Instagram links here..."></textarea><br>
  <button onclick="generateCards()">Generate Cards</button>
  <button onclick="loadData()">Reload from Sheets</button>

  <div id="cardsContainer"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxBER2pB5YO29Roh1brKonqoFVqIn69eQZNnXU7k742UyZoX-Uxz5tshrB-1zXHht-ZPg/exec";

    function parseUsername(link) {
      try {
        let url = new URL(link.trim());
        return url.pathname.split("/").filter(Boolean)[0];
      } catch {
        return null;
      }
    }

    function generateCards() {
      const input = document.getElementById("bulkInput").value.trim();
      if (!input) { alert("Paste links first!"); return; }
      const links = input.split("\n").map(l => l.trim()).filter(l => l);
      const container = document.getElementById("cardsContainer");
      container.innerHTML = "";
      links.forEach(link => {
        const username = parseUsername(link);
        if (!username) return;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <p><b>${username}</b></p>
          <input type="text" placeholder="Email" class="email"><br>
          <select class="status">
            <option value="Active">Active</option>
            <option value="Not Active">Not Active</option>
          </select><br>
          <button onclick="saveCard('${link}','${username}', this)">Save</button>
        `;
        container.appendChild(card);
      });
    }

    async function saveCard(link, username, btn) {
      const card = btn.parentElement;
      const email = card.querySelector(".email").value;
      const status = card.querySelector(".status").value;
      const payload = { link, username, email, status, date: new Date().toLocaleString() };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          mode: "cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        console.log("Save response:", json);
        alert(json.status === "success" ? "Saved!" : "Error saving");
      } catch (err) {
        console.error("Save error:", err);
        alert("Save failed");
      }
    }

    async function loadData() {
      try {
        const res = await fetch(API_URL, { method: "GET", mode: "cors" });
        const json = await res.json();
        console.log("Load response:", json);
        const container = document.getElementById("cardsContainer");
        container.innerHTML = "";
        json.data.forEach(row => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <p><b>${row.username}</b> (saved ${row.date})</p>
            <input type="text" value="${row.email}" class="email"><br>
            <select class="status">
              <option ${row.status==="Active"?"selected":""}>Active</option>
              <option ${row.status==="Not Active"?"selected":""}>Not Active</option>
            </select><br>
            <button onclick="saveCard('${row.link}','${row.username}', this)">Update</button>
          `;
          container.appendChild(card);
        });
      } catch (err) {
        console.error("Load error:", err);
        alert("Load failed");
      }
    }

    loadData();
  </script>
</body>
</html>
